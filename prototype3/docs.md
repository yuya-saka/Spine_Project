# 頸椎骨折検出システム 実装要件定義書

## 1. プロジェクト概要

- **目的:** 頸椎CT画像（スライス）から、MIL（Multiple Instance Learning）を用いて骨折の有無を判定し、かつ骨折部位の局在化（ヒートマップ化）を可能にする。
    
- **アプローチ:**
    
    - **Bag:** 1枚のスライス画像 ($128 \times 128$)
        
    - **Instance:** CNNの特徴マップ上のグリッド ($4 \times 4$ 領域)
        
    - **学習手法:** マスク情報を活用したマルチタスクLossによる弱教師あり学習
        

## 2. データ要件

### 2.1 入力データ仕様

- **ソース形式:** `.npy` ファイル（3Dボリューム）
    
- **ボリュームサイズ:** $128 \times 128 \times 64$ voxel
    
- **チャンネル構成 (3ch):**
    
    1. **Bone Window:** 骨強調のHU値
        
    2. **Soft Tissue / Subdural Window:** 軟部組織・出血強調のHU値
        
    3. **Vertebra Mask:** 椎体領域のセグメンテーション（0:背景, 1:椎体）
        
- **ラベル:** スライスレベルの骨折有無（Binary: 0 or 1）
    

### 2.2 データ前処理 (DataLoader内)

- **スライス抽出:** 3DボリュームのZ軸方向から2Dスライスを取り出し、独立したサンプルとして扱う。
    
- **正規化:** 画像値は0〜1、または正規分布にスケーリング済みであること。
    
- **Data Augmentation:**
    
    - **必須:** Random Rotate, Flip（左右反転）

    - オンライン拡張で、骨折あり画像のみに適用
        

## 3. モデルアーキテクチャ要件

### 3.1 バックボーン (Feature Extractor)

- **モデル:** ResNet18 (Pretrained on ImageNet)
    
- **変更点:**
    
    - 最終段の `avgpool` および `fc` 層を削除。
        
    - 出力特徴マップサイズ: $(B, 512, 4, 4)$ （入力が$128 \times 128$の場合）
        

### 3.2 MILヘッド & 分類器

- **パッチ化ロジック:**
    
    - $4 \times 4$ の特徴マップをフラット化し、16個のインスタンスベクトル ($512$次元) として扱う。
        
- **インスタンス分類器 (Instance Classifier):**
    
    - 構成: `Linear(512 -> 1)` + `Sigmoid`
        
    - 出力: 各パッチごとの骨折確率 $P_i \in [0, 1]$ (Shape: $[B, 16]$)
        
- **マスク処理:**
    
    - 入力のCh3（マスク）を `AdaptiveAvgPool2d` で $4 \times 4$ に縮小。
        
    - 閾値処理（例: $>0.1$）を行い、各パッチが「骨」か「背景」かのフラグ $M_i \in \{0, 1\}$ を生成。
        

## 4. 学習要件 (Loss設計)

### 4.1 損失関数 (Custom Fracture MIL Loss)

以下の3つの項の加重和で構成する。

1. **背景抑制 ($L_{bg}$):**
    
    - 条件: $M_i = 0$ (背景パッチ)
        
    - 計算: 予測 $P_i$ と 目標値 $0$ とのBCE Loss。
        
    - 目的: 骨のない場所での誤検知（False Positive）を極限まで減らす。
        
2. **骨領域・最大値 ($L_{max}$):**
    
    - 条件: $M_i = 1$ (骨パッチ)
        
    - 計算: 骨パッチ群の中の最大値 $\max(P_i)$ と スライスラベル $Y$ とのBCE Loss。
        
    - 目的: 「どこか一箇所でも折れていれば骨折」というMILの主タスク。
        
3. **骨領域・平均値 ($L_{mean}$):**
    
    - 条件: $M_i = 1$ (骨パッチ)
        
    - 計算: 骨パッチ群の平均値 $\text{mean}(P_i)$ と スライスラベル $Y$ とのBCE Loss。
        
    - 目的: 学習の安定化（弱ラベルとしての正則化）。
        

### 4.2 ハイパーパラメータ (推奨初期値)

- **Loss重み:**
    
    - $W_{bg} = 1.0 \sim 2.0$ (背景誤検知へのペナルティを強く)
        
    - $W_{max} = 1.0$
        
    - $W_{mean} = 0.5$ (局所性を維持するため弱めに)
        
- **Optimizer:** AdamW (Learning Rate: $1e-4 \sim 1e-3$)
    
- **Batch Size:** 32 〜 64 (メモリが許す限り大きく)
    

## 5. 出力・評価要件

### 5.1 推論時の出力

1. **スライス骨折確率:** $\max(P_i)$ （骨領域内）を使用。
    
2. **ヒートマップ:** $4 \times 4$ の $P_i$ を $128 \times 128$ にBilinear Upsamplingして元の画像に重ね合わせる。
    
3. 検証PR-AUCからF1最適化で分類閾値決定

### 5.2 評価指標

- **定量評価:**
    
    - ROC-AUC (Area Under the Curve)

    - PR-AUC (最重要)
        
    - Sensitivity (感度) / Specificity (特異度)
        
    - F1-Score
        
- **定性評価:**
    
    - True Positive画像のヒートマップを確認し、正しく「骨折線」や「変形部位」を指しているか目視確認。